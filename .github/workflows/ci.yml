name: CI
on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # --- 1) Quick “secret leak” guardrails ---
      # Fail if common secret files or patterns are present.
      - name: Secret hygiene (files)
        run: |
          set -e
          # Block obvious files
          bad_files="$(git ls-files | grep -E '\.env$|\.env\.local$|id_rsa(\.pub)?$|\.pem$|\.p12$|\.pfx$' || true)"
          if [ -n "$bad_files" ]; then
            echo "::error::Sensitive files committed:\n$bad_files"
            exit 1
          fi

      - name: Secret hygiene (patterns)
        run: |
          set -e
          # Grep for some very common secret patterns (best-effort).
          # (Does not scan binaries; avoids .git)
          if grep -RInE --exclude-dir=.git --binary-files=without-match \
              'AWS_ACCESS_KEY_ID|AWS_SECRET_ACCESS_KEY|GOOGLE_API_KEY|xoxb-|password=|passwd=|SECRET_KEY|PRIVATE KEY-----' . ; then
            echo "::error::Potential secrets detected above. Remove/rotate before merging."
            exit 1
          fi

      # --- 2) Frontend (optional/auto) ---
      # If a package.json exists, install deps and run lint/tests *if those scripts exist*.
      - name: Use Node if package.json exists
        if: ${{ hashFiles('package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: npm ci (if package.json)
        if: ${{ hashFiles('package.json') != '' }}
        run: npm ci

      - name: npm run lint (if defined)
        if: ${{ hashFiles('package.json') != '' }}
        run: |
          if npm run | grep -qE '^ *lint'; then
            npm run lint
          else
            echo "No lint script; skipping."
          fi

      - name: npm test (if defined)
        if: ${{ hashFiles('package.json') != '' }}
        run: |
          if npm run | grep -qE '^ *test'; then
            npm test --silent --if-present
          else
            echo "No test script; skipping."
          fi

      # --- 3) Placeholder success (so the job stays green if nothing else runs) ---
      - name: Final OK
        run: echo "CI checks completed."

      # --- CFML lint (optional – turn on later) ---
      # When you’re ready to lint ColdFusion/CFML, we can wire up a linter step here.
      # Example (placeholder):
      # - name: CFLint (example)
      #   run: |
      #     echo "Run CFML linter here (CFLint/CommandBox)."
      #     # We’ll drop in the exact commands once your CFML toolchain is chosen.
